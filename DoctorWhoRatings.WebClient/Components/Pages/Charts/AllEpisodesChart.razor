@page "/charts/all-episodes"
@inject IAllEpisodesDataGenerator AllEpisodesDataGenerator

<div class="nav-bar">
    <NavLink href="" Match="NavLinkMatch.All">
        <div class="nav-item">Home</div>
    </NavLink>
</div>

<div class="page-container">
    <div class="title-block">
        <div class="title">@AllEpisodesData.Title</div>
        <div>@AllEpisodesData.Description</div>
    </div>

    <div class="chart-container ">
        <ApexChart TItem="EpisodeDataPoint"
                   Title="@AllEpisodesData.YAxisTitle"
                   Options="Options"
                   Height="@("100%")"
                   Width="@("100%")">

            <ApexPointTooltip>
                @{
                    var dataPoint = context.DataPoint.Items.First();

                    <div class="tooltip">
                        <div class="tooltip-block">
                            <div class="tooltip-actor">@dataPoint.Episode.Actor</div>

                            <div class="tooltip-story">@dataPoint.Episode.StoryTitle</div>

                            @if (dataPoint.Episode.PartTitle != null)
                            {
                                <div>@dataPoint.Episode.PartTitle</div>
                            }

                            <div class="tooltip-season">@dataPoint.Episode.SeasonFormatDescription @dataPoint.Episode.Season</div>
                        </div>

                        <div class="tooltip-break"></div>

                        <div class="tooltip-block tooltip-icon-block">
                            <img class="tooltip-icon" src="images/calendar.svg" alt="Ratings" />
                            <div>
                                <span>Broadcast on </span>
                                <span class="highlighted-value">@dataPoint.Episode.OriginalAirDate.ToString("dd MMMM yyyy")</span>
                            </div>
                        </div>

                        <div class="tooltip-break"></div>

                        <div class="tooltip-block tooltip-icon-block">
                            <img class="tooltip-icon" src="images/view.svg" alt="Ratings" />
                            <div>
                                @if (dataPoint.Episode.OvernightRatings != null)
                                {
                                    <div>
                                        <span class="highlighted-value">@FormatNumber(dataPoint.Episode.OvernightRatings)</span>
                                        <span> million overnight viewers</span>
                                    </div>
                                }

                                @if (dataPoint.Episode.ConsolidatedRatings != null)
                                {
                                    <div>
                                        <span class="highlighted-value">@FormatNumber(dataPoint.Episode.ConsolidatedRatings)</span>
                                        <span> million viewers after seven days</span>
                                    </div>
                                }

                                @if (dataPoint.Episode.ExtendedRatings != null)
                                {
                                    <div>
                                        <span class="highlighted-value">@FormatNumber(dataPoint.Episode.ExtendedRatings)</span>
                                        <span> million viewers after seven days on all devices</span>
                                    </div>
                                }

                                @if (dataPoint.Episode.PopulationFactor != 1)
                                {
                                    <div class="tooltip-population-adjusted">Population adjusted</div>

                                    @if (dataPoint.Episode.PopulationAdjustedOvernightRatings != null)
                                    {
                                        <div>
                                            <span class="highlighted-value">@FormatNumber(dataPoint.Episode.PopulationAdjustedOvernightRatings)</span>
                                            <span> million overnight viewers</span>
                                        </div>
                                    }

                                    @if (dataPoint.Episode.PopulationAdjustedConsolidatedRatings != null)
                                    {
                                        <div>
                                            <span class="highlighted-value">@FormatNumber(dataPoint.Episode.PopulationAdjustedConsolidatedRatings)</span>
                                            <span> million viewers after seven days</span>
                                        </div>
                                    }

                                    @if (dataPoint.Episode.PopulationAdjustedExtendedRatings != null)
                                    {
                                        <div>
                                            <span class="highlighted-value">@FormatNumber(dataPoint.Episode.PopulationAdjustedExtendedRatings)</span>
                                            <span> million viewers after seven days on all devices</span>
                                        </div>
                                    }
                                }
                            </div>
                        </div>

                        @if (dataPoint.Episode.Note != null)
                        {
                            <div class="tooltip-break"></div>

                            <div class="tooltip-block tooltip-icon-block">
                                <img class="tooltip-icon" src="images/note.svg" alt="Note" />
                                <div>@FormatNote(dataPoint.Episode.Note)</div>
                            </div>
                        }
                    </div>
                }
            </ApexPointTooltip>

            <ChildContent>
                <ApexPointSeries TItem="EpisodeDataPoint"
                                 Items="DataSource.DataPoints"
                                 Name="AllEpisodes"
                                 SeriesType="SeriesType.Bar"
                                 XValue="dp => dp.Episode.Id"
                                 YValue="dp => dp.Episode.OvernightRatings" />
            </ChildContent>
        </ApexChart>
    </div>
</div>

@code {
    private ApexChartOptions<EpisodeDataPoint> Options { get; } = new();
    private AllEpisodesData DataSource { get; set; } = null!;

    public MarkupString FormatNote(string note) => 
        new (string.Join("<br />", note.Split("*", StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)));

    public string FormatNumber(decimal? number) => number?.ToString("0.00") ?? "N/A";

    protected override void OnInitialized()
    {
        DataSource = AllEpisodesDataGenerator.Generate();

        Options.PlotOptions = new PlotOptions
            {
                Bar = new PlotOptionsBar
                {
                    ColumnWidth = "90%"
                }
            };

        Options.Xaxis = new XAxis
        {
            Title = new AxisTitle
            {
                Text = AllEpisodesData.XAxisTitle,
                OffsetY = -6
            },
            Labels = new XAxisLabels
            {
                Show = false
            },
            TickPlacement = TickPlacement.On
        };
    }
}
