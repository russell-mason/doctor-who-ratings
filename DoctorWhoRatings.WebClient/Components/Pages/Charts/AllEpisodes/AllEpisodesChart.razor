@page "/charts/all-episodes"
@inject IAllEpisodesDataGenerator AllEpisodesDataGenerator

<PageTitle>@AllEpisodesData.Title - @Application.Name</PageTitle>

<ChartHeading Title="@AllEpisodesData.Title"
              Description="@AllEpisodesData.Description" />

<Chart>
    <ApexChart @ref="Chart" 
               TItem="AllEpisodesDataPoint"
               Title="@AllEpisodesData.YAxisTitle"
               Options="ChartOptions"
               Height="@("100%")"
               Width="@("100%")">

        <ApexPointTooltip>
            <AllEpisodeTooltip DataPoint="@context.DataPoint.Items.First()"
                               SeriesIndex="@context.SeriesIndex" />
        </ApexPointTooltip>

        <ChildContent>
            <ApexPointSeries TItem="AllEpisodesDataPoint"
                             Items="DataSource.DataPoints"
                             Name="@AllEpisodesData.SeriesTitles[0]"
                             SeriesType="SeriesType.Bar"
                             XValue="dataPoint => dataPoint.Id"
                             YValue="dataPoint => DataOptions.AdjustForCurrentPopulation ? dataPoint.PopulationAdjustedOvernightRatings : dataPoint.OvernightRatings" />
            
            <ApexPointSeries TItem="AllEpisodesDataPoint"
                             Items="DataSource.DataPoints"
                             Name="@AllEpisodesData.SeriesTitles[1]"
                             SeriesType="SeriesType.Bar"
                             XValue="dataPoint => dataPoint.Id"
                             YValue="dataPoint => DataOptions.AdjustForCurrentPopulation ? dataPoint.PopulationAdjustedConsolidatedExcessRatings: dataPoint.ConsolidatedExcessRatings" />
            
            <ApexPointSeries TItem="AllEpisodesDataPoint"
                             Items="DataSource.DataPoints"
                             Name="@AllEpisodesData.SeriesTitles[2]"
                             SeriesType="SeriesType.Bar"
                             XValue="dataPoint => dataPoint.Id"
                             YValue="dataPoint => DataOptions.AdjustForCurrentPopulation ? dataPoint.PopulationAdjustedExtendedExcessRatings : dataPoint.ExtendedExcessRatings" />
        </ChildContent>
    </ApexChart>
</Chart>
    
<ChartOptions>
    <ChartOptionsSet>
        <ChartOptionsCheckbox @bind-Value="DataOptions.AdjustForCurrentPopulation"
                              Id="population" Label="Adjust relative to current population"
                              AfterChanged="AfterOptionChanged">
        </ChartOptionsCheckbox>
    </ChartOptionsSet>
</ChartOptions>

@code {
    private ApexChart<AllEpisodesDataPoint> Chart { get; set; } = default!;

    private ApexChartOptions<AllEpisodesDataPoint> ChartOptions { get; } = AllEpisodesChartOptions.Defaults;

    private AllEpisodesData DataSource { get; set; } = default!;

    private AllEpisodesDataOptions DataOptions { get; } = new();

    protected override void OnInitialized() => DataSource = AllEpisodesDataGenerator.Generate();

    private async Task AfterOptionChanged()
    {
        DataSource = AllEpisodesDataGenerator.Generate();

        StateHasChanged();

        await Chart.UpdateSeriesAsync();
    }
}
